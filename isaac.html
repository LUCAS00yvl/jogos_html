<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isaac Blocks: Rebirth Edition</title>
    <style>
        :root { --bg: #0a0a0a; --paper: #dcd0b8; --ink: #2b2b2b; --accent: #ff4d4d; }
        body { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; background-color: #000; color: #eee; 
            font-family: 'Courier New', Courier, monospace; overflow: hidden; touch-action: none;
        }
        
        /* MENU CLÁSSICO "WHO AM I?" */
        #menu {
            position: absolute; inset: 0; background: #050505;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        #menu h1 { font-size: 36px; color: #fff; text-shadow: 2px 2px #555; margin-bottom: 30px; letter-spacing: 2px; }
        
        .char-selector { display: flex; align-items: center; gap: 20px; }
        .nav-btn { background: none; border: none; color: #555; font-size: 50px; cursor: pointer; transition: 0.2s; }
        .nav-btn:hover { color: #fff; }
        .nav-btn:active { transform: scale(0.9); }

        .paper-card {
            background: var(--paper); color: var(--ink); width: 220px; height: 320px; padding: 20px;
            border-radius: 2px; box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; position: relative;
            transform: rotate(-2deg);
        }
        
        .avatar-display { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #000; margin-top: 10px; box-shadow: 5px 5px 0 rgba(0,0,0,0.2); }
        .paper-card h2 { margin: 15px 0 10px; font-size: 28px; border-bottom: 2px dashed #000; width: 100%; text-align: center; }
        .stats-display { text-align: left; width: 100%; font-weight: bold; font-size: 14px; line-height: 1.6; }
        .hearts { color: var(--accent); }

        #start-btn {
            margin-top: 40px; background: transparent; border: 3px solid #fff; color: #fff;
            padding: 10px 40px; font-size: 24px; font-family: 'Courier New', Courier, monospace;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        #start-btn:hover { background: #fff; color: #000; }

        /* UI DO JOGO */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        #item-banner {
            position: absolute; top: -150px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; border: 4px solid #444; padding: 15px 50px;
            text-align: center; transition: top 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        #item-banner.show { top: 50px; }

        canvas { 
            border: 4px solid #222; background: #000; 
            max-width: 95vw; max-height: 80vh; 
            image-rendering: pixelated; border-radius: 8px;
        }

        /* CONTROLES MOBILE */
        .controls {
            position: absolute; bottom: 20px; width: 100%; height: 140px;
            display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
            z-index: 500; opacity: 0.6;
        }
        .joy-base { width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; position: relative; }
        .joy-knob { width: 40px; height: 40px; background: #aaa; border-radius: 50%; position: absolute; left: 30px; top: 30px; pointer-events: none; }
        
        .hidden { display: none !important; }
        @media (min-width: 1024px) { .controls { display: none; } }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="color: #666; font-size: 16px; margin-bottom: 10px;">PC: WASD (Mover) | SETAS (Atirar)</h1>
        <h1>WHO AM I?</h1>
        <div class="char-selector">
            <button class="nav-btn" onclick="changeChar(-1)">&#9664;</button>
            <div class="paper-card">
                <div id="m-avatar" class="avatar-display" style="background:#ffccb3;"></div>
                <h2 id="m-name">ISAAC</h2>
                <div class="stats-display">
                    HP: <span id="m-hp" class="hearts">♥♥♥</span><br>
                    DMG: <span id="m-dmg">3.5</span><br>
                    SPD: <span id="m-spd">4.0</span><br>
                    TEARS: <span id="m-trs">10</span><br>
                    RNG: <span id="m-rng">23.7</span>
                </div>
            </div>
            <button class="nav-btn" onclick="changeChar(1)">&#9654;</button>
        </div>
        <button id="start-btn" onclick="startGame()">SPACE TO START</button>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="item-banner">
            <h2 id="it-name" style="margin:0; font-size: 24px;">ITEM!</h2>
            <p id="it-stat" style="margin:5px 0 0; font-weight:bold; color: #ff4d4d;">STATS UP</p>
        </div>
    </div>

    <canvas id="gameCanvas" width="900" height="600" class="hidden"></canvas>

    <div class="controls hidden" id="ui-controls">
        <div class="joy-base" id="joy-move"><div class="joy-knob" id="knob-move"></div></div>
        <div class="joy-base" id="joy-shoot"><div class="joy-knob" id="knob-shoot"></div></div>
    </div>

    <script>
        // --- DADOS DOS PERSONAGENS BASEADOS NA WIKI ---
        const CHARACTERS = [
            { id: 'isaac', name: 'ISAAC', hp: 3, speed: 4.0, dmg: 3.50, fireRate: 25, range: 45, wep: 'tear', color: '#ffccb3', fly: false },
            { id: 'maggy', name: 'MAGGY', hp: 4, speed: 3.0, dmg: 3.50, fireRate: 25, range: 45, wep: 'tear', color: '#ffb3ba', fly: false },
            { id: 'cain', name: 'CAIN', hp: 2, speed: 4.5, dmg: 4.20, fireRate: 25, range: 35, wep: 'tear', color: '#cca28a', fly: false },
            { id: 'judas', name: 'JUDAS', hp: 1, speed: 4.0, dmg: 4.75, fireRate: 25, range: 45, wep: 'tear', color: '#911', fly: false },
            { id: 'eve', name: 'EVE', hp: 2, speed: 4.3, dmg: 2.62, fireRate: 20, range: 45, wep: 'tear', color: '#333', fly: false },
            { id: 'azazel', name: 'AZAZEL', hp: 3, speed: 4.3, dmg: 5.50, fireRate: 35, range: 15, wep: 'laser', color: '#111', fly: true }
        ];
        let currentCharIndex = 0;

        function updateMenuDisplay() {
            const c = CHARACTERS[currentCharIndex];
            document.getElementById('m-name').innerText = c.name;
            document.getElementById('m-avatar').style.background = c.color;
            document.getElementById('m-avatar').style.borderColor = c.id === 'azazel' || c.id === 'judas' || c.id === 'eve' ? '#a22' : '#000';
            document.getElementById('m-hp').innerText = '♥'.repeat(c.hp);
            document.getElementById('m-dmg').innerText = c.dmg.toFixed(2);
            document.getElementById('m-spd').innerText = (c.speed / 4.0).toFixed(2);
            document.getElementById('m-trs').innerText = (30 - c.fireRate).toString();
            document.getElementById('m-rng').innerText = c.range.toString();
        }

        function changeChar(dir) {
            currentCharIndex += dir;
            if (currentCharIndex < 0) currentCharIndex = CHARACTERS.length - 1;
            if (currentCharIndex >= CHARACTERS.length) currentCharIndex = 0;
            updateMenuDisplay();
        }

        window.addEventListener('keydown', e => {
            if (document.getElementById('menu').classList.contains('hidden')) return;
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') changeChar(-1);
            if (e.code === 'ArrowRight' || e.code === 'KeyD') changeChar(1);
            if (e.code === 'Space' || e.code === 'Enter') startGame();
        });
        updateMenuDisplay();

        // --- SISTEMA CORE DO JOGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TILE = 50, GRID_W = 18, GRID_H = 12;

        let player, enemies = [], projectiles = [], enemyProjectiles = [], particles = [], pickups = [], upgrade = null;
        let game = { floor: 1, active: false, palette: null, state: 'playing', trapdoor: null };
        let currentMap = [];

        const moveIn = { x: 0, y: 0, id: null };
        const shootIn = { x: 0, y: 0, id: null };
        const keys = {};

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function updateKeyboardInput() {
            if (keys['KeyD'] || keys['KeyA'] || keys['KeyS'] || keys['KeyW']) {
                moveIn.x = keys['KeyD'] ? 1 : (keys['KeyA'] ? -1 : 0);
                moveIn.y = keys['KeyS'] ? 1 : (keys['KeyW'] ? -1 : 0);
            } else if (moveIn.id === null) { moveIn.x = 0; moveIn.y = 0; }

            if (keys['ArrowRight'] || keys['ArrowLeft'] || keys['ArrowDown'] || keys['ArrowUp']) {
                shootIn.x = keys['ArrowRight'] ? 1 : (keys['ArrowLeft'] ? -1 : 0);
                shootIn.y = keys['ArrowDown'] ? 1 : (keys['ArrowUp'] ? -1 : 0);
            } else if (shootIn.id === null) { shootIn.x = 0; shootIn.y = 0; }
        }

        function setupJoy(baseId, knobId, input) {
            const base = document.getElementById(baseId);
            const knob = document.getElementById(knobId);
            const limit = 40;
            const handle = (t) => {
                const rect = base.getBoundingClientRect();
                const dx = t.clientX - (rect.left + rect.width/2);
                const dy = t.clientY - (rect.top + rect.height/2);
                const d = Math.sqrt(dx*dx + dy*dy) || 1;
                const r = Math.min(d, limit) / d;
                knob.style.transform = `translate(${dx*r}px, ${dy*r}px)`;
                input.x = (dx*r)/limit; input.y = (dy*r)/limit;
            };
            base.addEventListener('touchstart', e => { input.id = e.changedTouches[0].identifier; handle(e.changedTouches[0]); }, {passive:false});
            base.addEventListener('touchmove', e => { for(let t of e.changedTouches) if(t.identifier === input.id) handle(t); }, {passive:false});
            base.addEventListener('touchend', e => {
                for(let t of e.changedTouches) if(t.identifier === input.id) {
                    input.id = null; input.x = 0; input.y = 0; knob.style.transform = `translate(0,0)`;
                }
            }, {passive:false});
        }

        const PALETTES = {
            1: { floor: "#2b2b2b", wall: "#111", rock: "#444", spike: "#888", name: "BASEMENT" },
            3: { floor: "#1a2a3a", wall: "#0a101a", rock: "#2a4a6a", spike: "#68a", name: "CAVES" },
            5: { floor: "#3a1515", wall: "#1a0505", rock: "#5a2525", spike: "#a55", name: "DEPTHS" }
        };

        const ITEMS = [
            { n: "SAD ONION", s: "TEARS UP", color: "#ddd", f: (p) => p.fireRate = Math.max(5, p.fireRate-8) },
            { n: "PENTAGRAM", s: "DMG UP", color: "#a22", f: (p) => p.dmg += 1.0 },
            { n: "MAGIC MUSHROOM", s: "ALL STATS UP", color: "#f55", f: (p) => { p.dmg += 0.5; p.speed += 0.5; p.hp++; p.max++; p.tearScale *= 1.2; p.range += 10; } },
            { n: "THE HALO", s: "ALL STATS UP", color: "#ff0", f: (p) => { p.dmg += 0.3; p.speed += 0.2; p.hp++; p.max++; p.fireRate -= 2; } },
            { n: "BLOOD OF THE MARTYR", s: "DMG UP", color: "#900", f: (p) => p.dmg += 1.0 },
            { n: "SPOON BENDER", s: "HOMING TEARS", color: "#a5e", f: (p) => p.homing = true },
            { n: "POLYPHEMUS", s: "MEGA TEARS", color: "#eef", f: (p) => { p.dmg += 5.0; p.fireRate += 30; p.tearScale = 2.5; } },
            { n: "NUMBER ONE", s: "TEARS UP", color: "#ff0", f: (p) => { p.fireRate = Math.max(5, p.fireRate - 12); p.range -= 20; } },
            { n: "20/20", s: "DOUBLE SHOT", color: "#eee", f: (p) => p.multiShot = 2 },
            { n: "MUTANT SPIDER", s: "QUAD SHOT", color: "#5a5", f: (p) => p.multiShot = 4 },
            { n: "BRIMSTONE", s: "BLOOD LASER BARRAGE", color: "#200", f: (p) => { p.wep = 'laser'; p.dmg += 2.0; p.fireRate += 15; p.color = '#111'; p.range = Math.max(p.range, 30); } },
            { n: "CUBE OF MEAT", s: "ORBITAL", color: "#a33", f: (p) => p.orbitals.push(new Orbital(p.orbitals.length)) }
        ];

        class Orbital {
            constructor(index) { this.angle = index * Math.PI; this.dist = 40; }
            update() { this.angle += 0.05; }
            draw(px, py) {
                let x = px + Math.cos(this.angle)*this.dist, y = py + Math.sin(this.angle)*this.dist;
                ctx.fillStyle = "#822"; ctx.fillRect(x-8, y-8, 16, 16);
                ctx.fillStyle = "#a33"; ctx.fillRect(x-6, y-6, 12, 12);
                ctx.fillStyle = "#fff"; ctx.fillRect(x-2, y-2, 4, 4);
            }
        }

        class Pickup {
            constructor(x, y, type) { this.x = x; this.y = y; this.type = type; this.floatY = 0; }
            draw() {
                this.floatY = Math.sin(Date.now()/150)*4;
                if(this.type === 'heart') {
                    ctx.fillStyle = "#f00"; ctx.strokeStyle = "#000"; ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(this.x-5, this.y+this.floatY, 5, Math.PI, 0); ctx.arc(this.x+5, this.y+this.floatY, 5, Math.PI, 0);
                    ctx.lineTo(this.x, this.y+10+this.floatY); ctx.closePath(); ctx.fill(); ctx.stroke();
                }
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 8; this.vy = (Math.random() - 0.5) * 8;
                this.life = 20 + Math.random() * 10; this.maxLife = this.life;
            }
            update() { this.x += this.vx; this.y += this.vy; this.vx *= 0.9; this.vy *= 0.9; this.life--; }
            draw() {
                ctx.globalAlpha = this.life / this.maxLife; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
            }
        }

        class Player {
            constructor(c) {
                this.x = canvas.width/2; this.y = canvas.height/2; 
                this.hp = c.hp; this.max = c.hp; this.speed = c.speed; this.dmg = c.dmg; 
                this.fireRate = c.fireRate; this.range = c.range; this.color = c.color; 
                this.wep = c.wep; this.fly = c.fly; this.cd = 0; this.inv = 0; 
                this.multiShot = 1; this.homing = false; this.tearScale = 1.0; 
                this.orbitals = []; this.vx = 0; this.vy = 0;
            }
            update() {
                if(this.inv > 0) this.inv--;
                updateKeyboardInput();

                this.vx = moveIn.x * this.speed; this.vy = moveIn.y * this.speed;
                let nx = this.x + this.vx; let ny = this.y + this.vy;
                
                if(!isObstacle(nx, this.y, this.fly)) this.x = nx;
                if(!isObstacle(this.x, ny, this.fly)) this.y = ny;

                this.x = Math.max(80, Math.min(canvas.width - 80, this.x));
                this.y = Math.max(80, Math.min(canvas.height - 80, this.y));

                let gx = Math.floor(this.x/TILE), gy = Math.floor(this.y/TILE);
                if(currentMap[gy] && currentMap[gy][gx] === 3 && !this.fly) this.takeDmg(1);

                this.orbitals.forEach(o => o.update());

                if(this.cd > 0) this.cd--;
                if(Math.hypot(shootIn.x, shootIn.y) > 0.3 && this.cd <= 0 && game.state === 'playing') {
                    this.fire(); this.cd = this.fireRate;
                }
            }
            fire() {
                if(this.wep === 'laser') return; 
                const a = Math.atan2(shootIn.y, shootIn.x);
                const px = this.vx * 0.4, py = this.vy * 0.4;
                
                let angles = [];
                if (this.multiShot === 1) angles = [a];
                else if (this.multiShot === 2) angles = [a - 0.1, a + 0.1];
                else if (this.multiShot === 3) angles = [a - 0.2, a, a + 0.2];
                else if (this.multiShot === 4) angles = [a - 0.3, a - 0.1, a + 0.1, a + 0.3];
                
                angles.forEach(ang => projectiles.push(new Projectile(this.x, this.y-10, ang, this.dmg, px, py, false, this.homing, this.tearScale, this.range)));
            }
            takeDmg(n) {
                if(this.inv > 0) return;
                this.hp -= n; this.inv = 60;
                for(let i=0; i<10; i++) particles.push(new Particle(this.x, this.y, "#f00"));
                if(this.hp <= 0) { game.active = false; setTimeout(() => { alert("GAME OVER! Andares: " + game.floor); location.reload(); }, 100); }
            }
            draw() {
                if (this.inv > 0 && Math.floor(Date.now() / 100) % 2 === 0) return; 

                ctx.save();
                ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.beginPath(); ctx.ellipse(this.x, this.y+15, 14, 6, 0, 0, Math.PI*2); ctx.fill();

                ctx.fillStyle = this.color; ctx.beginPath(); ctx.ellipse(this.x, this.y+5, 12, 14, 0, 0, Math.PI*2); ctx.fill();
                ctx.lineWidth = 2; ctx.strokeStyle = "#000"; ctx.stroke();

                let headX = this.x + (shootIn.x * 3), headY = this.y - 12 + (shootIn.y * 3);
                ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(headX, headY, 16, 0, Math.PI*2); ctx.fill(); ctx.stroke();

                ctx.fillStyle = "#000";
                let eyeOffsetX = shootIn.x * 4, eyeOffsetY = shootIn.y * 4;
                ctx.beginPath(); ctx.arc(headX - 6 + eyeOffsetX, headY - 2 + eyeOffsetY, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(headX + 6 + eyeOffsetX, headY - 2 + eyeOffsetY, 3, 0, Math.PI*2); ctx.fill();

                if(this.wep === 'laser' && Math.hypot(shootIn.x, shootIn.y) > 0.5) {
                    ctx.strokeStyle = "rgba(255, 0, 0, 0.8)"; ctx.lineWidth = 25 * this.tearScale; ctx.lineCap = "round";
                    ctx.beginPath(); ctx.moveTo(headX, headY); ctx.lineTo(headX + shootIn.x * (this.range * 15), headY + shootIn.y * (this.range * 15)); ctx.stroke();
                    ctx.strokeStyle = this.homing ? "#a5e" : "#fff"; ctx.lineWidth = 10 * this.tearScale; ctx.stroke();
                }
                ctx.restore();

                this.orbitals.forEach(o => o.draw(this.x, this.y));
            }
        }

        class Projectile {
            constructor(x, y, a, d, px, py, isEnemy, homing = false, scale = 1.0, range = 45) { 
                this.x = x; this.y = y; 
                this.vx = Math.cos(a)* (isEnemy ? 6 : 10) + px; 
                this.vy = Math.sin(a)* (isEnemy ? 6 : 10) + py; 
                this.dmg = d; this.life = range; 
                this.isEnemy = isEnemy; this.homing = homing; this.scale = scale;
            }
            update() { 
                if(this.homing && !this.isEnemy && enemies.length > 0) {
                    let target = null, minDist = 250;
                    enemies.forEach(e => {
                        let d = Math.hypot(this.x-e.x, this.y-e.y);
                        if(d < minDist) { minDist = d; target = e; }
                    });
                    if(target) {
                        let a = Math.atan2(target.y-this.y, target.x-this.x);
                        this.vx += Math.cos(a)*1.5; this.vy += Math.sin(a)*1.5;
                        let s = Math.hypot(this.vx, this.vy);
                        this.vx = (this.vx/s)*10; this.vy = (this.vy/s)*10;
                    }
                }

                this.x += this.vx; this.y += this.vy; this.life--; 
                if(this.x < 50 || this.x > canvas.width-50 || this.y < 50 || this.y > canvas.height-50) this.life = 0;
                if(isObstacle(this.x, this.y, false)) this.life = 0;
            }
            draw() { 
                ctx.fillStyle = this.isEnemy ? "#ff4d4d" : (this.homing ? "#c7f" : "#a8d8ff"); 
                ctx.strokeStyle = this.isEnemy ? "#a00" : (this.homing ? "#62a" : "#4488cc"); 
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(this.x, this.y, 8 * this.scale, 0, Math.PI*2); ctx.fill(); ctx.stroke(); 
                
                ctx.fillStyle = "rgba(255,255,255,0.6)";
                ctx.beginPath(); ctx.arc(this.x-2, this.y-2, 3 * this.scale, 0, Math.PI*2); ctx.fill();
            }
            destroy() {
                let color = this.isEnemy ? "#ff4d4d" : (this.homing ? "#c7f" : "#a8d8ff");
                for(let i=0; i<4; i++) particles.push(new Particle(this.x, this.y, color));
            }
        }

        class Enemy {
            constructor(x, y, type) { 
                this.x = x; this.y = y; this.type = type;
                this.hitTimer = 0; this.vx = 0; this.vy = 0;
                this.attackCooldown = Math.random() * 60;

                switch(type) {
                    case 'gaper': this.hp = 10; this.size = 18; this.speed = 2.5; this.color = "#563"; this.fly = false; break;
                    case 'pooter': this.hp = 8; this.size = 14; this.speed = 1.0; this.color = "#222"; this.fly = true; break;
                    case 'clotty': this.hp = 15; this.size = 22; this.speed = 1.0; this.color = "#a22"; this.fly = false; break;
                    case 'boss': this.hp = 250; this.size = 35; this.speed = 1.8; this.color = "#822"; this.fly = false; break;
                }
                this.maxHp = this.hp;
            }
            update() {
                if (this.hitTimer > 0) this.hitTimer--;
                let dx = player.x - this.x, dy = player.y - this.y;
                let dist = Math.hypot(dx, dy) || 1;

                if (this.type === 'gaper' || this.type === 'boss') {
                    this.vx = (dx/dist) * this.speed; this.vy = (dy/dist) * this.speed;
                } else if (this.type === 'clotty') {
                    if (dist > 150) { this.vx = (dx/dist) * this.speed; this.vy = (dy/dist) * this.speed; } else { this.vx = 0; this.vy = 0; }
                } else if (this.type === 'pooter') {
                    if (dist > 200) { this.vx = (dx/dist) * this.speed; this.vy = (dy/dist) * this.speed; }
                    else if (dist < 100) { this.vx = -(dx/dist) * this.speed; this.vy = -(dy/dist) * this.speed; }
                    else { this.vx = 0; this.vy = 0; }
                }

                let nx = this.x + this.vx; let ny = this.y + this.vy;
                if(!isObstacle(nx, this.y, this.fly)) this.x = nx;
                if(!isObstacle(this.x, ny, this.fly)) this.y = ny;

                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.attackCooldown <= 0) {
                    if (this.type === 'pooter' && dist < 300) {
                        enemyProjectiles.push(new Projectile(this.x, this.y, Math.atan2(dy, dx), 1, 0, 0, true));
                        this.attackCooldown = 90;
                    } 
                    else if (this.type === 'clotty') {
                        enemyProjectiles.push(new Projectile(this.x, this.y, 0, 1, 0, 0, true));
                        enemyProjectiles.push(new Projectile(this.x, this.y, Math.PI/2, 1, 0, 0, true));
                        enemyProjectiles.push(new Projectile(this.x, this.y, Math.PI, 1, 0, 0, true));
                        enemyProjectiles.push(new Projectile(this.x, this.y, -Math.PI/2, 1, 0, 0, true));
                        this.attackCooldown = 120;
                    }
                    else if (this.type === 'boss' && dist < 400) {
                        let ang = Math.atan2(dy, dx);
                        for(let i=-2; i<=2; i++) enemyProjectiles.push(new Projectile(this.x, this.y, ang + (i*0.2), 1, 0, 0, true));
                        this.attackCooldown = 100;
                    }
                }
            }
            draw() {
                ctx.save();
                ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(this.x, this.y+this.size-2, this.size, this.size/2, 0, 0, Math.PI*2); ctx.fill();

                ctx.fillStyle = this.hitTimer > 0 ? "#fff" : this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                
                ctx.fillStyle = "#000";
                if (this.type === 'boss') {
                    ctx.beginPath(); ctx.arc(this.x-10, this.y-5, 6, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(this.x+10, this.y-5, 6, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(this.x, this.y+10, 12, 0, Math.PI); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.arc(this.x-this.size/2.5, this.y-2, 3, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(this.x+this.size/2.5, this.y-2, 3, 0, Math.PI*2); ctx.fill();
                }

                if (this.type === 'boss') {
                    ctx.fillStyle = "#000"; ctx.fillRect(canvas.width/2 - 100, 20, 200, 15);
                    ctx.fillStyle = "#a00"; ctx.fillRect(canvas.width/2 - 100, 20, 200 * (this.hp/this.maxHp), 15);
                    ctx.strokeStyle = "#444"; ctx.strokeRect(canvas.width/2 - 100, 20, 200, 15);
                }
                ctx.restore();
            }
        }

        function isObstacle(x, y, isFlying) {
            let gx = Math.floor(x/TILE), gy = Math.floor(y/TILE);
            if(gx <= 0 || gx >= GRID_W-1 || gy <= 0 || gy >= GRID_H-1) return true;
            if (currentMap[gy] && currentMap[gy][gx] === 1) return true; // Rocha
            return false;
        }

        function generateMap() {
            currentMap = Array.from({length: GRID_H}, () => Array(GRID_W).fill(0));
            for(let y=1; y<GRID_H-1; y++) {
                for(let x=1; x<GRID_W-1; x++) {
                    if (Math.hypot(x*TILE - canvas.width/2, y*TILE - canvas.height/2) < 150) continue;
                    let r = Math.random();
                    if(r < 0.12) currentMap[y][x] = 1; // Rocha
                    else if(r < 0.15) currentMap[y][x] = 3; // Espinho
                }
            }
        }

        function drawHUD() {
            for(let i=0; i<player.max; i++) {
                ctx.fillStyle = i < player.hp ? "#f00" : "#333";
                ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
                let hx = 20 + i*25, hy = 20;
                ctx.beginPath();
                ctx.arc(hx-5, hy, 6, Math.PI, 0); ctx.arc(hx+5, hy, 6, Math.PI, 0);
                ctx.lineTo(hx, hy+10); ctx.closePath(); ctx.fill(); ctx.stroke();
            }

            ctx.fillStyle = "rgba(255,255,255,0.7)"; ctx.font = "bold 14px monospace";
            ctx.fillText("FLOOR: " + game.floor, 20, 55);
            ctx.fillText("DMG: " + player.dmg.toFixed(2), 20, 75);
            ctx.fillText("SPD: " + (player.speed / 4.0).toFixed(2), 20, 95);
        }

        function startGame() {
            document.getElementById('menu').classList.add('hidden');
            ['ui-layer', 'gameCanvas', 'ui-controls'].forEach(id => document.getElementById(id).classList.remove('hidden'));

            const c = CHARACTERS[currentCharIndex];
            player = new Player(c);
            game.active = true; game.floor = 1;
            
            setupJoy('joy-move', 'knob-move', moveIn);
            setupJoy('joy-shoot', 'knob-shoot', shootIn);
            newFloor(); loop();
        }

        function newFloor() {
            let pKey = Object.keys(PALETTES).reverse().find(k => game.floor >= k) || 1;
            game.palette = PALETTES[pKey];
            game.trapdoor = null; upgrade = null; game.state = 'playing';
            
            player.x = canvas.width/2; player.y = canvas.height/2;
            generateMap(); 
            enemies = []; projectiles = []; enemyProjectiles = []; particles = []; pickups = [];
            
            let numEnemies = 2 + Math.floor(game.floor * 1.5);
            for(let i=0; i<numEnemies; i++) {
                let ex = Math.random()*(canvas.width-150)+75, ey = Math.random()*(canvas.height-150)+75;
                if(Math.hypot(ex-player.x, ey-player.y) > 200) {
                    let r = Math.random(), type = 'gaper';
                    if (game.floor > 1 && r > 0.5) type = 'pooter';
                    if (game.floor > 2 && r > 0.8) type = 'clotty';
                    enemies.push(new Enemy(ex, ey, type));
                } else i--; 
            }
            if (game.floor % 3 === 0) enemies.push(new Enemy(150, 150, 'boss'));
        }

        function loop() {
            if(!game.active) return;
            
            ctx.fillStyle = game.palette.wall; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = game.palette.floor; ctx.fillRect(TILE, TILE, canvas.width - TILE*2, canvas.height - TILE*2);
            ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.fillRect(TILE, TILE, canvas.width - TILE*2, 10);
            
            for(let y=1; y<GRID_H-1; y++) for(let x=1; x<GRID_W-1; x++) {
                let xp = x*TILE, yp = y*TILE;
                if(currentMap[y][x] === 1) { // Rocha
                    ctx.fillStyle = game.palette.rock; ctx.fillRect(xp + 2, yp + 2, TILE-4, TILE-4);
                    ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(xp + 2, yp + 40, TILE-4, 8);
                } else if (currentMap[y][x] === 3) { // Espinhos
                    ctx.fillStyle = "#333"; ctx.fillRect(xp+5, yp+5, TILE-10, TILE-10);
                    ctx.fillStyle = game.palette.spike;
                    ctx.beginPath(); ctx.moveTo(xp+10,yp+40); ctx.lineTo(xp+25,yp+10); ctx.lineTo(xp+40,yp+40); ctx.fill();
                }
            }

            if(game.trapdoor) {
                ctx.fillStyle = "#111"; ctx.fillRect(canvas.width/2 - 25, canvas.height/2 - 25, 50, 50);
                ctx.strokeStyle = "#444"; ctx.lineWidth = 4; ctx.strokeRect(canvas.width/2 - 25, canvas.height/2 - 25, 50, 50);
                ctx.fillStyle = "#333"; ctx.fillRect(canvas.width/2 - 20, canvas.height/2 - 15, 40, 5); ctx.fillRect(canvas.width/2 - 20, canvas.height/2 - 5, 40, 5);
                
                if (Math.hypot(player.x - canvas.width/2, player.y - canvas.height/2) < 20) {
                    game.floor++; newFloor(); requestAnimationFrame(loop); return;
                }
            }

            pickups.forEach((p, i) => {
                p.draw();
                if(Math.hypot(player.x - p.x, player.y - p.y) < 20) {
                    if (p.type === 'heart' && player.hp < player.max) { player.hp++; pickups.splice(i, 1); }
                }
            });

            if(enemies.length === 0 && !upgrade && !game.trapdoor) {
                upgrade = { x: canvas.width/2, y: canvas.height/2, item: ITEMS[Math.floor(Math.random()*ITEMS.length)], floatY: 0 };
            }

            if(upgrade) {
                upgrade.floatY = Math.sin(Date.now() / 200) * 5;
                ctx.fillStyle = "#555"; ctx.fillRect(upgrade.x - 15, upgrade.y + 10, 30, 20);
                ctx.fillStyle = "#777"; ctx.fillRect(upgrade.x - 20, upgrade.y + 5, 40, 5);
                
                ctx.fillStyle = upgrade.item.color; ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(upgrade.x, upgrade.y - 15 + upgrade.floatY, 12, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                
                if(Math.hypot(player.x-upgrade.x, player.y-upgrade.y) < 30) {
                    upgrade.item.f(player);
                    document.getElementById('it-name').innerText = upgrade.item.n;
                    document.getElementById('it-stat').innerText = upgrade.item.s;
                    const b = document.getElementById('item-banner');
                    b.classList.add('show'); setTimeout(() => b.classList.remove('show'), 2000);
                    upgrade = null; game.trapdoor = true;
                }
            }

            player.update(); player.draw();

            player.orbitals.forEach(o => {
                let ox = player.x + Math.cos(o.angle)*o.dist, oy = player.y + Math.sin(o.angle)*o.dist;
                enemies.forEach(e => { if(Math.hypot(ox-e.x, oy-e.y) < e.size + 15) { e.hp -= 0.1; e.hitTimer = 2; } });
                enemyProjectiles.forEach(p => { if(Math.hypot(ox-p.x, oy-p.y) < 15) p.life = 0; });
            });

            projectiles.forEach((p, i) => { p.update(); p.draw(); if(p.life <= 0) { p.destroy(); projectiles.splice(i, 1); } });

            enemyProjectiles.forEach((p, i) => {
                p.update(); p.draw();
                if(Math.hypot(p.x - player.x, p.y - player.y) < 15 && player.inv <= 0) { player.takeDmg(1); p.life = 0; }
                if(p.life <= 0) { p.destroy(); enemyProjectiles.splice(i, 1); }
            });

            enemies.forEach((e, i) => {
                e.update(); e.draw();
                projectiles.forEach((p, pi) => {
                    if(Math.hypot(p.x-e.x, p.y-e.y) < e.size + 8 * p.scale) {
                        e.hp -= p.dmg; e.hitTimer = 5;
                        for(let k=0; k<3; k++) particles.push(new Particle(p.x, p.y, "#f00"));
                        p.destroy(); projectiles.splice(pi, 1);
                    }
                });

                if(player.wep === 'laser' && Math.hypot(shootIn.x, shootIn.y) > 0.5) {
                    let dx = shootIn.x, dy = shootIn.y;
                    let ex = e.x - player.x, ey = e.y - player.y;
                    let dot = ex * dx + ey * dy;
                    if (dot > 0) {
                        let projX = dx * dot, projY = dy * dot;
                        if (Math.hypot(ex - projX, ey - projY) < e.size + 15 * player.tearScale) { e.hp -= player.dmg * 0.15; e.hitTimer = 2; }
                    }
                }

                if(Math.hypot(e.x-player.x, e.y-player.y) < e.size + 10) player.takeDmg(1);
                
                if(e.hp <= 0) {
                    for(let k=0; k<15; k++) particles.push(new Particle(e.x, e.y, "#900"));
                    if(Math.random() < 0.25) pickups.push(new Pickup(e.x, e.y, 'heart')); 
                    enemies.splice(i, 1);
                }
            });

            particles.forEach((p, i) => { p.update(); p.draw(); if(p.life <= 0) particles.splice(i, 1); });

            drawHUD();
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>