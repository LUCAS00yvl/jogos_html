<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celeste: Katana Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'serif'; }
        canvas { display: block; touch-action: none; }
        #ui {
            position: absolute; top: 10px; left: 10px;
            color: #f1e5ac; pointer-events: none;
            border: 3px double #5d4037; background: rgba(20, 10, 5, 0.8);
            padding: 12px; z-index: 10;
        }
        .bar-bg { width: 140px; height: 14px; background: #1a0505; border: 1px solid #ffd700; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(to right, #f00, #800); transition: 0.1s; }
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; }
        .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; backdrop-filter: blur(5px); border: 2px solid #fff; }
    </style>
</head>
<body>

    <div id="ui">
        <div style="font-size: 14px; letter-spacing: 2px;">ZERO PROTOCOL</div>
        <div class="bar-bg"><div id="hp-bar"></div></div>
    </div>

    <canvas id="gameCanvas"></canvas>
    
    <div class="controls">
        <div id="btnLeft" class="btn">â—€</div>
        <div id="btnRight" class="btn">â–¶</div>
        <div id="btnDash" class="btn" style="background: rgba(255, 0, 80, 0.4);">âš¡</div>
        <div id="btnJump" class="btn">â–²</div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- CONFIGURAÃ‡Ã•ES ---
const GRAVITY = 0.45;
const FRICTION = 0.8;
const WORLD_WIDTH = 10000;
let camera = { x: 0, y: 0 };
let shake = 0;
let timeStop = 0;
let flash = 0;

let particles = [];
let platforms = [];
let enemies = [];
let lightningBolts = [];

const player = {
    x: 100, y: 0, w: 30, h: 35,
    vx: 0, vy: 0, speed: 6, jumpPower: -11,
    grounded: false, wallSliding: 0, // -1 left, 1 right, 0 none
    dashing: false, dashCooldown: 0,
    hp: 100, facing: 1
};

function init() {
    platforms = [{ x: 0, y: canvas.height - 120, w: 600, h: 300 }];
    let lastY = canvas.height - 120;
    
    for (let i = 650; i < WORLD_WIDTH; i += 280) {
        // Altura MÃ¡xima Controlada: nunca sobe mais que 150px da anterior
        let nextY = Math.max(200, Math.min(canvas.height - 100, lastY + (Math.random() * 300 - 150)));
        let w = 120 + Math.random() * 150;
        platforms.push({ x: i, y: nextY, w: w, h: 500 });
        if(Math.random() > 0.5) enemies.push({ x: i + w/2, y: nextY - 80, originY: nextY - 80, angle: 0, dead: false });
        lastY = nextY;
    }
}

const keys = {};
const bind = (id, k) => {
    const el = document.getElementById(id);
    el.ontouchstart = (e) => { e.preventDefault(); keys[k] = true; };
    el.ontouchend = (e) => { e.preventDefault(); keys[k] = false; };
};
bind('btnLeft', 'left'); bind('btnRight', 'right'); bind('btnJump', 'jump'); bind('btnDash', 'dash');

function update() {
    if (timeStop > 0) { timeStop--; return; } // Efeito de impacto

    // Movimento
    if (!player.dashing) {
        if (keys.left) { player.vx = -player.speed; player.facing = -1; }
        else if (keys.right) { player.vx = player.speed; player.facing = 1; }
        else player.vx *= FRICTION;
        player.vy += player.wallSliding ? GRAVITY * 0.3 : GRAVITY;
    }

    // Wall Jump & Jump
    if (keys.jump) {
        if (player.grounded) {
            player.vy = player.jumpPower;
            player.grounded = false;
        } else if (player.wallSliding !== 0) {
            player.vy = player.jumpPower * 0.9;
            player.vx = -player.wallSliding * 12;
            player.wallSliding = 0;
            createParticles(player.x, player.y, '#fff', 5);
        }
    }

    // Dash
    if (keys.dash && player.dashCooldown <= 0) {
        player.dashing = true;
        player.dashCooldown = 40;
        player.vx = player.facing * 20;
        player.vy = -1;
        createParticles(player.x, player.y, '#ff0055', 20);
        setTimeout(() => player.dashing = false, 150);
    }

    player.x += player.vx;
    player.y += player.vy;

    // ColisÃµes Complexas
    player.grounded = false;
    player.wallSliding = 0;
    platforms.forEach(p => {
        if (player.x + player.w > p.x && player.x < p.x + p.w &&
            player.y + player.h > p.y && player.y < p.y + p.h) {
            
            let fromTop = Math.abs((player.y + player.h) - p.y);
            let fromLeft = Math.abs((player.x + player.w) - p.x);
            let fromRight = Math.abs(player.x - (p.x + p.w));

            if (fromTop < 15 && player.vy >= 0) {
                player.y = p.y - player.h;
                player.vy = 0;
                player.grounded = true;
            } else if (fromLeft < 15) {
                player.x = p.x - player.w;
                if (player.vy > 0) player.wallSliding = 1;
            } else if (fromRight < 15) {
                player.x = p.x + p.w;
                if (player.vy > 0) player.wallSliding = -1;
            }
        }
    });

    // Combate Katana Style
    enemies.forEach((en, i) => {
        en.y = en.originY + Math.sin(en.angle += 0.05) * 20;
        let dist = Math.hypot(player.x - en.x, player.y - en.y);
        
        if (dist < 50 && player.dashing) {
            triggerHitEffect(en.x, en.y);
            enemies.splice(i, 1);
            player.dashCooldown = 5; 
            player.vy = -10;
        }
    });

    // Camera & Shake
    camera.x += (player.x - canvas.width/3 - camera.x) * 0.1;
    if (shake > 0) shake--;
    if (flash > 0) flash--;
    if (player.dashCooldown > 0) player.dashCooldown--;
    
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) particles.splice(i, 1);
    });
}

function triggerHitEffect(x, y) {
    shake = 15;
    timeStop = 8;
    flash = 5;
    createParticles(x, y, '#ff0', 30);
    // Gerar Raios (Lightning Bolts)
    for(let i=0; i<5; i++) {
        lightningBolts.push({
            x, y, 
            tx: x + (Math.random()-0.5)*400, 
            ty: y + (Math.random()-0.5)*400,
            life: 10
        });
    }
}

function createParticles(x, y, color, amt) {
    for(let i=0; i<amt; i++) {
        particles.push({ x, y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 25, color });
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Background Gradiente
    let sky = ctx.createLinearGradient(0,0,0, canvas.height);
    sky.addColorStop(0, "#4facfe"); sky.addColorStop(1, "#f1e5ac");
    ctx.fillStyle = sky;
    ctx.fillRect(0,0,canvas.width, canvas.height);

    ctx.save();
    // Aplica Shake
    if (shake > 0) ctx.translate(Math.random()*shake, Math.random()*shake);
    ctx.translate(-camera.x, 0);

    // Desenhar Plataformas
    platforms.forEach(p => {
        let g = ctx.createLinearGradient(p.x, p.y, p.x, p.y+100);
        g.addColorStop(0, "#2d3436"); g.addColorStop(1, "#000");
        ctx.fillStyle = g;
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle = "#00cec9"; // Topo neon
        ctx.fillRect(p.x, p.y, p.w, 4);
    });

    // Raios (Katana Zero hit effect)
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 3;
    lightningBolts.forEach((b, i) => {
        ctx.beginPath();
        ctx.moveTo(b.x, b.y);
        ctx.lineTo(b.tx, b.ty);
        ctx.stroke();
        b.life--;
        if(b.life <= 0) lightningBolts.splice(i, 1);
    });

    // Inimigos
    ctx.font = "35px Arial";
    enemies.forEach(en => ctx.fillText("ðŸ‘¹", en.x, en.y));

    // Jogador com Espelhamento (Facing)
    ctx.save();
    ctx.translate(player.x + player.w/2, player.y + player.h/2);
    if (player.facing === -1) ctx.scale(-1, 1);
    ctx.fillText(player.dashing ? "âš”ï¸" : "ðŸ¥·", -15, 15);
    ctx.restore();

    // PartÃ­culas
    particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 4, 4);
    });

    ctx.restore();

    // Flash screen
    if(flash > 0) {
        ctx.fillStyle = `rgba(255,255,255,${flash/10})`;
        ctx.fillRect(0,0,canvas.width, canvas.height);
    }

    requestAnimationFrame(() => { update(); draw(); });
}

init();
draw();
</script>
</body>
</html>