<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Sea Pro: Aventura</title>
    <style>
        :root {
            --bar-border: #2c3e50; --success: #2ecc71; --fail: #e74c3c;
            --ui-bg: rgba(15, 25, 35, 0.95); --text-main: #ecf0f1;
        }
        * { box-sizing: border-box; touch-action: none; user-select: none; }
        body {
            margin: 0; padding: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #game-container {
            position: relative; width: 100vw; height: 100vh;
            max-width: 800px; overflow: hidden; background: #0a192f;
        }
        
        #hud {
            position: absolute; top: 0; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px 20px; color: var(--text-main); font-weight: bold; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            text-shadow: 1px 1px 3px #000; font-size: 14px; pointer-events: none;
        }
        .stats { display: flex; flex-direction: column; gap: 5px; }
        
        .progress-container {
            width: 140px; height: 12px; background: rgba(0,0,0,0.6);
            border-radius: 6px; border: 1px solid #bdc3c7; overflow: hidden; margin-top: 2px;
        }
        #o2-bar { height: 100%; width: 100%; background: #3498db; transition: width 0.1s linear; }
        #weight-bar { height: 100%; width: 0%; background: #f39c12; transition: width 0.3s; }

        #qte-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 300px; height: 40px;
            background: var(--bar-border); padding: 4px; border-radius: 20px;
            display: none; z-index: 200; box-shadow: 0 0 15px rgba(0,0,0,0.8); pointer-events: none;
        }
        #qte-bar { position: relative; width: 100%; height: 100%; background: var(--fail); border-radius: 16px; overflow: hidden; }
        #success-zone { position: absolute; height: 100%; background: var(--success); }
        #indicator {
            position: absolute; top: 50%; width: 6px; height: 120%;
            background: #fff; transform: translate(-50%, -50%);
            border-radius: 3px; z-index: 210; box-shadow: 0 0 8px #f1c40f;
        }

        #shop-btn {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: #e67e22; color: #fff; border: 2px solid #d35400;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; z-index: 100;
            display: none; transition: transform 0.1s; pointer-events: auto;
        }
        #shop-btn:active { transform: translateX(-50%) scale(0.95); }
        
        #shop-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 300; color: white;
            pointer-events: auto;
        }
        .shop-panel {
            background: var(--ui-bg); padding: 20px; border-radius: 12px;
            width: 90%; max-width: 400px; text-align: center; border: 1px solid #34495e;
        }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .shop-item span { text-align: left; font-size: 14px; }
        .shop-item small { color: #bdc3c7; font-size: 11px; display: block; margin-top: 4px; }
        .shop-item button {
            padding: 8px 15px; background: #2ecc71; color: white; border: none;
            border-radius: 5px; font-weight: bold; cursor: pointer; min-width: 70px;
        }
        .shop-item button:disabled { background: #7f8c8d; cursor: not-allowed; opacity: 0.5; }
        #close-shop {
            margin-top: 15px; padding: 12px 20px; background: #e74c3c; width: 100%;
            color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        #msg-overlay {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000;
            pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 250; text-align: center;
        }
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 500; color: white; cursor: pointer; text-align: center; padding: 20px; pointer-events: auto;
        }

        #joy-base {
            position: absolute; bottom: 20px; left: 20px; width: 100px; height: 100px;
            background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            display: none; z-index: 50; pointer-events: none;
        }
        #joy-stick {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen">
        <h1>ü§ø Dave's Dive</h1>
        <p><strong>PC:</strong> WASD para nadar, Clique para atirar.</p>
        <p><strong>Mobile:</strong> Arraste do lado esquerdo para mover, toque no direito para atirar.</p>
        <p style="color: #e74c3c; font-size: 14px; margin-top: 10px;">Evite √Åguas-vivas e Minas! Elas drenam seu O2.</p>
        <br><p style="color: #f1c40f;">[ Clique/Toque para iniciar ]</p>
    </div>

    <div id="hud">
        <div class="stats">
            <span>üí∞ $<span id="score">0</span></span>
            <span>‚öì Prof.: <span id="depth-ui">0</span>m</span>
        </div>
        <div class="stats" style="align-items: flex-end;">
            <span>ü§ø O2</span>
            <div class="progress-container"><div id="o2-bar"></div></div>
            <span style="margin-top:5px">üì¶ Peso (<span id="weight-text">0/10</span>kg)</span>
            <div class="progress-container"><div id="weight-bar"></div></div>
        </div>
    </div>

    <div id="msg-overlay"></div>

    <div id="qte-container">
        <div id="qte-bar"><div id="success-zone"></div></div>
        <div id="indicator"></div>
    </div>

    <div id="joy-base"><div id="joy-stick"></div></div>

    <button id="shop-btn" onclick="openShop()">üõí Loja e Upgrades</button>

    <div id="shop-modal">
        <div class="shop-panel">
            <h2>Melhorias do Mergulhador</h2>
            <p style="color: #f1c40f; font-weight: bold;">Saldo: $<span id="shop-money">0</span></p>
            
            <div class="shop-item">
                <span>ü§ø Tanque O2<small>Mais tempo debaixo d'√°gua</small></span>
                <button id="btn-up-o2" onclick="buyUpgrade('o2')">$50</button>
            </div>
            <div class="shop-item">
                <span>üéØ Ponta do Arp√£o<small>Facilita a captura</small></span>
                <button id="btn-up-lure" onclick="buyUpgrade('lure')">$75</button>
            </div>
            <div class="shop-item">
                <span>üì¶ Mochila de Carga<small>Carregue peixes mais pesados</small></span>
                <button id="btn-up-cargo" onclick="buyUpgrade('cargo')">$100</button>
            </div>
            <div class="shop-item">
                <span>üèä Nadadeiras<small>Nade mais r√°pido</small></span>
                <button id="btn-up-speed" onclick="buyUpgrade('speed')">$120</button>
            </div>
            
            <button id="close-shop" onclick="closeShop()">Voltar a Mergulhar</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ui = {
        score: document.getElementById('score'), depth: document.getElementById('depth-ui'),
        o2bar: document.getElementById('o2-bar'), weightBar: document.getElementById('weight-bar'),
        weightText: document.getElementById('weight-text'), qteCont: document.getElementById('qte-container'),
        indicator: document.getElementById('indicator'), successZone: document.getElementById('success-zone'),
        shopBtn: document.getElementById('shop-btn'), shopModal: document.getElementById('shop-modal'),
        shopMoney: document.getElementById('shop-money'), msg: document.getElementById('msg-overlay'),
        startScreen: document.getElementById('start-screen'), joyBase: document.getElementById('joy-base'),
        joyStick: document.getElementById('joy-stick')
    };

    let width, height;
    let isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    function resize() {
        width = canvas.width = window.innerWidth > 800 ? 800 : window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize); resize();

    // Estado Global
    let money = 0;
    let upgrades = { o2Level: 1, lureLevel: 1, cargoLevel: 1, speedLevel: 1 };
    const prices = { o2: 50, lure: 75, cargo: 100, speed: 120 };
    
    let maxO2 = 100, currentO2 = maxO2;
    let maxWeight = 10, currentWeight = 0;
    let caughtFishes = []; 
    let camera = { x: 0, y: 0 };

    let diver = { x: width/2, y: 50, vx: 0, vy: 0, dir: 1, state: 'idle', hurtTimer: 0 };
    let harpoon = { active: false, x: 0, y: 0, tx: 0, ty: 0, speed: 18, returning: false, targetFish: null };
    
    // Entidades
    let fishes = [];
    let obstacles = [];
    let loots = [];
    
    // QTE
    let qteActive = false, qtePos = 0, qteDir = 1, targetRange = { min: 0, max: 0 }, currentQteSpeed = 2;

    const fishDatabase = [
        { icon: 'üêü', name: 'Sardinha', value: 15, weight: 1, qteSpeed: 1.5, qteWidth: 35, minD: 0, maxD: 600 },
        { icon: 'üê†', name: 'Peixe Ex√≥tico', value: 35, weight: 2, qteSpeed: 2.2, qteWidth: 25, minD: 200, maxD: 1000 },
        { icon: 'üê°', name: 'Baiacu', value: 70, weight: 4, qteSpeed: 3.5, qteWidth: 15, minD: 800, maxD: 2000 },
        { icon: 'ü¶ë', name: 'Lula Gigante', value: 160, weight: 8, qteSpeed: 5, qteWidth: 10, minD: 1500, maxD: 3500 },
        { icon: 'ü¶à', name: 'Tubar√£o', value: 450, weight: 20, qteSpeed: 7, qteWidth: 6, minD: 2500, maxD: 6000 }
    ];

    class Entity {
        constructor(icon, minD, maxD) {
            this.icon = icon;
            this.x = diver.x + (Math.random() > 0.5 ? width : -width);
            this.y = Math.max(200, diver.y + (Math.random() * height - height/2));
            this.id = Math.random();
        }
        draw(ctx) {
            ctx.font = "35px Arial";
            ctx.fillText(this.icon, this.x - 17, this.y + 10);
        }
    }

    class Fish extends Entity {
        constructor() {
            super('', 0, 6000);
            const available = fishDatabase.filter(f => diver.y >= f.minD - 400 && diver.y <= f.maxD + 400);
            const template = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : fishDatabase[0];
            Object.assign(this, template);
            this.speed = (Math.random() * 1.5 + 0.5) * (this.x > diver.x ? -1 : 1);
        }
        draw(ctx) {
            ctx.font = "35px Arial"; ctx.save();
            if (this.speed < 0) { ctx.translate(this.x, this.y); ctx.scale(-1, 1); ctx.fillText(this.icon, -17, 10); } 
            else { ctx.fillText(this.icon, this.x - 17, this.y + 10); }
            ctx.restore();
        }
    }

    class Obstacle extends Entity {
        constructor() {
            super(Math.random() > 0.5 ? 'ü™º' : 'üí£', 100, 6000); // √Ågua-viva ou Mina
            this.damage = this.icon === 'üí£' ? 25 : 10;
        }
    }

    class Loot extends Entity {
        constructor() {
            super(Math.random() > 0.8 ? 'üíé' : 'ü™ô', 500, 6000);
            this.value = this.icon === 'üíé' ? 100 : 25;
            this.y = diver.y + height/2 + Math.random() * 200; // Spawna mais pra baixo
        }
    }

    // --- UI E MENSAGENS ---
    function showMessage(text, color = "white") {
        ui.msg.innerHTML = text; ui.msg.style.color = color;
        ui.msg.style.opacity = 1; setTimeout(() => ui.msg.style.opacity = 0, 2000);
    }

    window.openShop = function() { ui.shopModal.style.display = 'flex'; ui.shopMoney.innerText = money; updateShopButtons(); }
    window.closeShop = function() { ui.shopModal.style.display = 'none'; currentO2 = maxO2; }
    window.buyUpgrade = function(type) {
        let cost = prices[type] * upgrades[type + 'Level'];
        if (money >= cost) {
            money -= cost; upgrades[type + 'Level']++;
            if(type === 'o2') maxO2 = 100 + (upgrades.o2Level * 30);
            if(type === 'cargo') { maxWeight = 10 + (upgrades.cargoLevel * 10); updateWeightUI(); }
            ui.shopMoney.innerText = money; ui.score.innerText = money; updateShopButtons();
        }
    }
    function updateShopButtons() {
        ['o2', 'lure', 'cargo', 'speed'].forEach(type => {
            let cost = prices[type] * upgrades[type + 'Level'];
            let btn = document.getElementById(`btn-up-${type}`);
            btn.innerText = `$${cost}`; btn.disabled = money < cost;
        });
    }
    function updateWeightUI() {
        ui.weightText.innerText = `${currentWeight}/${maxWeight}`;
        let pct = (currentWeight / maxWeight) * 100;
        ui.weightBar.style.width = Math.min(pct, 100) + "%";
        ui.weightBar.style.background = pct >= 100 ? '#e74c3c' : '#f39c12';
    }

    // --- L√ìGICA DO JOGO ---
    function shootHarpoon(screenX, screenY) {
        if (harpoon.active || diver.state === 'qte' || diver.y < 120) return;
        
        const rect = canvas.getBoundingClientRect();
        const worldX = (screenX - rect.left) + camera.x;
        const worldY = (screenY - rect.top) + camera.y;
        
        harpoon.active = true; harpoon.returning = false; harpoon.targetFish = null;
        harpoon.x = diver.x; harpoon.y = diver.y;
        
        let angle = Math.atan2(worldY - diver.y, worldX - diver.x);
        harpoon.tx = Math.cos(angle) * harpoon.speed;
        harpoon.ty = Math.sin(angle) * harpoon.speed;
        diver.dir = harpoon.tx > 0 ? 1 : -1; 
    }

    function startQTE(fish) {
        if (currentWeight + fish.weight > maxWeight) {
            showMessage("Pesado demais!", "#f1c40f");
            harpoon.returning = true; return; 
        }
        
        diver.state = 'qte'; harpoon.targetFish = fish;
        qteActive = true; qtePos = 0;
        
        const finalWidth = Math.min(fish.qteWidth + (upgrades.lureLevel * 3), 50);
        currentQteSpeed = fish.qteSpeed;
        const start = 10 + Math.random() * (80 - finalWidth);
        targetRange = { min: start, max: start + finalWidth };
        
        ui.successZone.style.left = start + "%"; ui.successZone.style.width = finalWidth + "%";
        ui.qteCont.style.display = 'block';
    }

    function checkQTE() {
        if(!qteActive) return;
        if(qtePos >= targetRange.min && qtePos <= targetRange.max) {
            showMessage(`Pegou: ${harpoon.targetFish.name}!`, "#2ecc71");
            caughtFishes.push(harpoon.targetFish);
            currentWeight += harpoon.targetFish.weight; updateWeightUI();
            fishes = fishes.filter(f => f.id !== harpoon.targetFish.id); 
        } else {
            showMessage("Escapou...", "#e74c3c");
        }
        qteActive = false; ui.qteCont.style.display = 'none';
        harpoon.returning = true; diver.state = 'swimming';
    }

    function returnToBoat(isRescue = false) {
        if(isRescue) {
            showMessage("Sem Oxig√™nio!<br>Resgatado sem os peixes.", "#e74c3c");
            caughtFishes = []; currentWeight = 0; updateWeightUI();
        } else if (caughtFishes.length > 0) {
            let total = caughtFishes.reduce((sum, f) => sum + f.value, 0);
            money += total; ui.score.innerText = money;
            showMessage(`Vendeu tudo<br>por $${total}!`, "#f1c40f");
            caughtFishes = []; currentWeight = 0; updateWeightUI();
        }
        currentO2 = maxO2;
        diver.x = width/2; diver.y = 50; diver.vx = 0; diver.vy = 0;
    }

    // --- INPUT E CONTROLES ---
    ui.startScreen.addEventListener('click', () => { ui.startScreen.style.display = 'none'; });

    const keys = { w: false, a: false, s: false, d: false };
    let inputDir = { x: 0, y: 0 };
    
    window.addEventListener('keydown', e => {
        let k = e.key.toLowerCase(); if(keys.hasOwnProperty(k)) keys[k] = true;
        if(k === ' ' && qteActive) checkQTE();
    });
    window.addEventListener('keyup', e => { let k = e.key.toLowerCase(); if(keys.hasOwnProperty(k)) keys[k] = false; });

    // Eventos focados no Canvas
    canvas.addEventListener('pointerdown', e => {
        if (qteActive) { checkQTE(); return; }
        if (isMobile) {
            if (e.clientX < width / 2) {
                ui.joyBase.style.display = 'block';
                ui.joyBase.style.left = (e.clientX - 50) + 'px';
                ui.joyBase.style.top = (e.clientY - 50) + 'px';
                inputDir.originX = e.clientX; inputDir.originY = e.clientY;
                inputDir.active = true;
            } else {
                shootHarpoon(e.clientX, e.clientY);
            }
        } else {
            shootHarpoon(e.clientX, e.clientY);
        }
    });

    canvas.addEventListener('pointermove', e => {
        if (isMobile && inputDir.active && e.clientX < width / 2) {
            let dx = e.clientX - inputDir.originX;
            let dy = e.clientY - inputDir.originY;
            let dist = Math.hypot(dx, dy);
            let maxDist = 40;
            
            if(dist > maxDist) { dx = (dx/dist)*maxDist; dy = (dy/dist)*maxDist; }
            
            ui.joyStick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            // Normaliza input para -1 a 1
            inputDir.x = dx / maxDist;
            inputDir.y = dy / maxDist;
        }
    });

    window.addEventListener('pointerup', e => {
        if (isMobile) {
            inputDir.active = false; inputDir.x = 0; inputDir.y = 0;
            ui.joyBase.style.display = 'none';
            ui.joyStick.style.transform = `translate(-50%, -50%)`;
        }
    });

    // --- LOOP PRINCIPAL ---
    function update() {
        if (diver.state !== 'qte') {
            let speedLimit = 4 + (upgrades.speedLevel * 1);
            let accel = 0.8;
            let tx = 0, ty = 0;

            if (keys.w) ty -= 1; if (keys.s) ty += 1;
            if (keys.a) tx -= 1; if (keys.d) tx += 1;
            
            if (isMobile && inputDir.active) { tx = inputDir.x; ty = inputDir.y; }

            // Normaliza diagonal do teclado
            if(tx !== 0 && ty !== 0 && !isMobile) { tx *= 0.707; ty *= 0.707; }

            diver.vx += tx * accel; diver.vy += ty * accel;
            
            // Atrito fluido
            diver.vx *= 0.85; diver.vy *= 0.85;
            
            diver.x += Math.max(Math.min(diver.vx, speedLimit), -speedLimit);
            diver.y += Math.max(Math.min(diver.vy, speedLimit), -speedLimit);

            if (Math.abs(diver.vx) > 0.5) diver.dir = diver.vx > 0 ? 1 : -1;
            if (diver.y < 50) diver.y = 50; 
            
            if (diver.hurtTimer > 0) diver.hurtTimer--;

            // O2 e Barco
            if (diver.y > 150) {
                ui.shopBtn.style.display = 'none';
                currentO2 -= 0.04;
                if (currentO2 <= 0) returnToBoat(true);
            } else {
                if(caughtFishes.length > 0) returnToBoat(false);
                ui.shopBtn.style.display = 'block';
                currentO2 = Math.min(currentO2 + 0.5, maxO2);
            }
        }
        
        ui.o2bar.style.width = (currentO2 / maxO2 * 100) + "%";
        ui.o2bar.style.background = currentO2 < maxO2 * 0.25 ? '#e74c3c' : '#3498db';
        let prof = Math.max(0, Math.floor((diver.y - 150) / 10));
        ui.depth.innerText = prof;

        camera.x += (diver.x - width/2 - camera.x) * 0.1;
        camera.y += (diver.y - height/2 - camera.y) * 0.1;
        if (camera.y < 0) camera.y = 0;

        // Render Fundo
        let darkness = Math.min(0.95, prof / 300);
        ctx.fillStyle = `rgba(0, 15, 30, ${darkness})`;
        ctx.fillRect(0, 0, width, height);

        ctx.save(); ctx.translate(-camera.x, -camera.y);

        if (camera.y < height) ctx.clearRect(camera.x, 0, width, 150);
        ctx.fillStyle = "rgba(255, 255, 255, 0.1)"; ctx.fillRect(camera.x, 150, width, 5);
        ctx.font = "60px Arial"; ctx.fillText("üö§", width/2 - 40, 130); 

        // Spawn Entities
        if (diver.y > 150) {
            if (Math.random() < 0.04 && fishes.length < 15) fishes.push(new Fish());
            if (Math.random() < 0.01 && obstacles.length < 5) obstacles.push(new Obstacle());
            if (Math.random() < 0.005 && loots.length < 3) loots.push(new Loot());
        }

        // Render e L√≥gica Entidades
        let allEntities = [...fishes, ...obstacles, ...loots];
        
        for (let i = allEntities.length - 1; i >= 0; i--) {
            let e = allEntities[i];
            
            if (e instanceof Fish && diver.state !== 'qte') e.x += e.speed;
            if (e instanceof Loot) e.y -= 0.2; // Loot flutua devagar
            
            e.draw(ctx);

            // Dist√¢ncia do mergulhador
            let distDiver = Math.hypot(diver.x - e.x, diver.y - e.y);

            // Colis√µes com o Mergulhador
            if (distDiver < 40 && diver.state !== 'qte') {
                if (e instanceof Obstacle && diver.hurtTimer === 0) {
                    currentO2 -= e.damage;
                    diver.hurtTimer = 60;
                    showMessage("Ai!", "#e74c3c");
                    obstacles = obstacles.filter(o => o.id !== e.id); // Destr√≥i o obst√°culo
                } else if (e instanceof Loot) {
                    money += e.value; ui.score.innerText = money;
                    showMessage(`+ $${e.value}`, "#f1c40f");
                    loots = loots.filter(l => l.id !== e.id); // Coleta
                }
            }

            // Arp√£o acerta Peixe
            if (harpoon.active && !harpoon.returning && !qteActive && e instanceof Fish) {
                if (Math.hypot(harpoon.x - e.x, harpoon.y - e.y) < 30) startQTE(e);
            }
            
            // Limpeza
            if (e.x < camera.x - width || e.x > camera.x + width * 2 || e.y < camera.y - height || e.y > camera.y + height * 2) {
                if(e instanceof Fish) fishes = fishes.filter(f => f.id !== e.id);
                if(e instanceof Obstacle) obstacles = obstacles.filter(o => o.id !== e.id);
                if(e instanceof Loot) loots = loots.filter(l => l.id !== e.id);
            }
        }

        // Render Arp√£o
        if (harpoon.active) {
            ctx.strokeStyle = "rgba(200,200,200,0.8)"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(diver.x, diver.y); ctx.lineTo(harpoon.x, harpoon.y); ctx.stroke();
            ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(harpoon.x, harpoon.y, 4, 0, Math.PI*2); ctx.fill();

            if (!qteActive) {
                if (!harpoon.returning) {
                    harpoon.x += harpoon.tx; harpoon.y += harpoon.ty;
                    if (Math.hypot(harpoon.x - diver.x, harpoon.y - diver.y) > 250) harpoon.returning = true;
                } else {
                    let rAng = Math.atan2(diver.y - harpoon.y, diver.x - harpoon.x);
                    harpoon.x += Math.cos(rAng) * (harpoon.speed + 5); harpoon.y += Math.sin(rAng) * (harpoon.speed + 5);
                    if (Math.hypot(harpoon.x - diver.x, harpoon.y - diver.y) < 20) harpoon.active = false;
                }
            }
        }

        // Render Mergulhador
        ctx.font = "40px Arial"; ctx.save(); ctx.translate(diver.x, diver.y);
        if (diver.dir < 0) ctx.scale(-1, 1);
        
        // Efeito de dano
        if (diver.hurtTimer > 0 && Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.5;
        
        ctx.fillText("ü§ø", -20, 15);
        ctx.restore();

        if(caughtFishes.length > 0) {
            ctx.fillStyle = "#fff"; ctx.font = "14px Arial"; 
            ctx.fillText(`üì¶ ${currentWeight}kg`, diver.x - 20, diver.y - 25);
        }

        ctx.restore(); // Fim Camera

        // Update QTE UI
        if(qteActive) {
            qtePos += currentQteSpeed * qteDir;
            if(qtePos >= 100) { qtePos = 100; qteDir = -1; }
            if(qtePos <= 0) { qtePos = 0; qteDir = 1; }
            ui.indicator.style.left = qtePos + "%";
        }

        requestAnimationFrame(update);
    }
    update();
</script>
</body>
</html>